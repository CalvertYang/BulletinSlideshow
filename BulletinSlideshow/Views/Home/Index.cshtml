@model IEnumerable<BulletinSlideshow.Models.Information>

@{
    ViewBag.Title = "Bulletin Slideshow";
}

@section scripts {
    <script>
        $(function () {
            var slideInterval = @ViewBag.Parameter.SlideInterval

            $('.notifyMessage').marquee({
                speed: 7000,
                gap: 50,
                delayBeforeStart: 0,
                direction: 'left',
                duplicated: false
            });

            // Information Tab
            var infoTabCarousel = setInterval(function () {
                var tabs = $('#information .nav-tabs > li'),
                    active = tabs.filter('.active'),
                    next = active.next('li'),
                    toClick = next.length ? next.find('a') : tabs.eq(0).find('a');

                toClick.tab('show');
            }, slideInterval);

            $('#information').mouseover(function () {
                clearInterval(infoTabCarousel);
            }).mouseout(function () {
                infoTabCarousel = setInterval(function () {
                    var tabs = $('#information .nav-tabs > li'),
                        active = tabs.filter('.active'),
                        next = active.next('li'),
                        toClick = next.length ? next.find('a') : tabs.eq(0).find('a');

                    toClick.tab('show');
                }, slideInterval);
            });

            // Project Tab
            var projectTabCarousel = setInterval(function () {
                var tabs = $('#project .nav-tabs > li'),
                    active = tabs.filter('.active'),
                    next = active.next('li'),
                    toClick = next.length ? next.find('a') : tabs.eq(0).find('a');

                toClick.tab('show');
            }, slideInterval);

            $('#project').mouseover(function () {
                clearInterval(projectTabCarousel);
            }).mouseout(function () {
                projectTabCarousel = setInterval(function () {
                    var tabs = $('#project .nav-tabs > li'),
                        active = tabs.filter('.active'),
                        next = active.next('li'),
                        toClick = next.length ? next.find('a') : tabs.eq(0).find('a');

                    toClick.tab('show');
                }, slideInterval);
            });

            // SignalR
            var push = $.connection.pushNotification;

            push.client.refreshPage = function () {
                location.reload();
            };

            // Information Block
            push.client.addInformationCategory = function (category) {
                $('#information').parent().parent().css("display", "");

                $('#information .nav-tabs').append(
                    '<li id="infoNavTab'+ category.Id + '"><a href="#infoTab' +
                    category.Id + '" data-toggle="tab">' + category.Name +
                    '</a></li>'
                );
                $('#information .tab-content').append(
                    '<div class="tab-pane" id="infoTab' + category.Id + '" style="height:200px;">' +
                    '<h1 id="infoTitle' + category.Id + '">' +
                    category.Name + '</h1><ul style="margin-left:30px;"></ul></div>'
                );
            };

            push.client.editInformationCategory = function (category) {
                $('#infoNavTab' + category.Id + ' > a').text(category.Name);
                $('#infoTitle' + category.Id).text(category.Name);
            };

            push.client.deleteInformationCategory = function (categoryId) {
                $('#infoNavTab' + categoryId).remove();
                $('#infoTab' + categoryId).remove();

                // Hide project tab
                if ($('#information .nav-tabs').children().length == 0) {
                    $('#information').parent().parent().css("display", "none");
                }
            };
            
            push.client.addInformationContent = function (information) {
                $('#infoTab' + information.CategoryId + ' > ul').append(
                    '<li id="infoContent' + information.Id + '">' + information.Content + '</li>'
                );
            };

            push.client.editInformationContent = function (information) {
                var parentId = $('#infoContent' + information.Id).parent().parent().attr('id').replace('infoTab', '');

                if (parentId == information.CategoryId) {
                    $('#infoContent' + information.Id).text(information.Content);
                } else {
                    $('#infoContent' + information.Id).remove();
                    $('#infoTab' + information.CategoryId + ' > ul').append(
                        '<li id="infoContent' + information.Id + '">' + information.Content + '</li>'
                    );
                }
            };

            push.client.deleteInformationContent = function (informationId) {
                $('#infoContent' + informationId).remove();
            };

            // Project Block
            push.client.addProject = function (project) {
                $('#project').parent().parent().css("display", "");

                // Add Tab
                $('#project .nav-tabs').append(
                    '<li id="projectNavTab' + project.Id + '"><a href="#projectTab' +
                    project.Id + '" data-toggle="tab">' + project.Name +
                    '</a></li>'
                );
                $('#project .tab-content').append(
                    '<div class="tab-pane" id="projectTab' + project.Id + '" style="height: 550px;">' +
                    '<h1 id="projectTitle' + project.Id + '">' + project.Name + '</h1>' +
                    '<div class="alert alert-block"><h2>現狀</h2>' +
                    '<span id="projectSituation' + project.Id + '" style="white-space: pre-line">' + project.Situation + '</span>' +
                    '</div><div class="alert alert-success"><h2>方案</h2>' +
                    '<span id="projectPlan' + project.Id + '" style="white-space: pre-line">' + project.Plan + '</span>' +
                    '</div><div class="well"><b>負責人：</b><span id="projectDirector' + project.Id + '">' + project.Director + '</span></div></div>'
                );
            };

            push.client.editProject = function (project) {
                $('#projectNavTab' + project.Id + ' > a').text(project.Name);
                $('#projectTitle' + project.Id).text(project.Name);
                $('#projectSituation' + project.Id).text(project.Situation);
                $('#projectPlan' + project.Id).text(project.Plan);
                $('#projectDirector' + project.Id).text(project.Director);
            };

            push.client.deleteProject = function (projectId) {
                $('#projectNavTab' + projectId).remove();
                $('#projectTab' + projectId).remove();
                
                // Hide project tab
                if ($('#project .nav-tabs').children().length == 0) {
                    $('#project').parent().parent().css("display", "none");
                }
            };
            

            // Connect to hub
            $.connection.hub.start()
            .done(function () {
                console.log("Connection Successful.");
            })
            .fail(function (ex) {
                console.log("Connection Failed.");
            });
        });
    </script>
}

<style>
    .nav-tabs li {
        font-size: xx-small;
    }
    .tab-content, .tab-content li {
        font-size: xx-large;
        line-height: normal;
    }
</style>

@{ bool isFirstElement = false; }
<div class="container-fluid" style="height:250px;@{if (ViewBag.Category.Count == 0) {<text> display: none;</text>}}">
    <div class="row-fluid">
        <div id="information" class="tabbable">
            <ul class="nav nav-tabs">
                @{ isFirstElement = true; }
                @foreach (var category in ViewBag.Category)
                {
                    <li id="infoNavTab@(category.Id)"@{if (isFirstElement) {<text>class=" active"</text>}}><a href="#infoTab@(category.Id)" data-toggle="tab">@category.Name</a></li>
                    isFirstElement = false;
                }
            </ul>
            <div class="tab-content">
                @{ isFirstElement = true; }
                @foreach (var category in ViewBag.Category)
                {
                    <div class="tab-pane@{if (isFirstElement) {<text> active</text>}}" id="infoTab@(category.Id)" style="height:200px;">
                        <h1 id="infoTitle@(category.Id)">@category.Name</h1>
                        <ul style="margin-left:30px;">
                            @foreach (var info in Model)
                            {

                                if (info.CategoryId == category.Id)
                                {
                                <li id="infoContent@(info.Id)">@info.Content</li>
                                }
                            }
                        </ul>
                    </div>
                    isFirstElement = false;
                }
            </div>
        </div>
    </div>
</div>

@if (ViewBag.NotifyMessage != null)
{
    <br />
    <div class="notifyMessage well" style="font-size: xx-large; font-weight: bold">
        @ViewBag.NotifyMessage
    </div>
}

<div class="container-fluid" style="height: 600px;@{if (ViewBag.Project.Count == 0) {<text> display: none;</text>}}">
    <div class="row-fluid">
        <div id="project" class="tabbable">
            <ul class="nav nav-tabs">
                @{ isFirstElement = true; }
                @foreach (var project in ViewBag.Project)
                {
                    <li id="projectNavTab@(project.Id)"@{if (isFirstElement) {<text>class="active"</text>}}><a href="#projectTab@(project.Id)" data-toggle="tab">@project.Name</a></li>
                    isFirstElement = false;
                }
            </ul>
            <div class="tab-content">
                @{ isFirstElement = true; }
                @foreach (var project in ViewBag.Project)
                {
                    <div class="tab-pane@{if (isFirstElement) {<text> active</text>}}" id="projectTab@(project.Id)" style="height:550px;">
                        <h1 id="projectTitle@(project.Id)">@project.Name</h1>
                        <div class="alert alert-block">
                            <h2>現狀</h2>
                            <span id="projectSituation@(project.Id)" style="white-space: pre-line">@project.Situation</span>
                        </div>
                        <div class="alert alert-success">
                            <h2>方案</h2>
                            <span id="projectPlan@(project.Id)" style="white-space: pre-line">@project.Plan</span>
                        </div>
                        <div class="well">
                            <b>負責人：</b><span id="projectDirector@(project.Id)">@project.Director</span>
                        </div>
                    </div>
                    isFirstElement = false;
                }
            </div>
        </div>
    </div>
</div>
